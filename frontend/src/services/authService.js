import axios from 'axios';\n\nconst API_BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:3001/api';\n\n// Create axios instance\nconst apiClient = axios.create({\n  baseURL: API_BASE_URL,\n  withCredentials: true, // Include cookies for refresh token\n  headers: {\n    'Content-Type': 'application/json'\n  }\n});\n\n// Token storage\nconst TOKEN_KEY = 'stockspot_access_token';\n\nclass AuthService {\n  constructor() {\n    this.setupInterceptors();\n  }\n\n  /**\n   * Setup axios interceptors for token handling\n   */\n  setupInterceptors() {\n    // Request interceptor - add auth token\n    apiClient.interceptors.request.use(\n      (config) => {\n        const token = this.getToken();\n        if (token) {\n          config.headers.Authorization = `Bearer ${token}`;\n        }\n        return config;\n      },\n      (error) => Promise.reject(error)\n    );\n\n    // Response interceptor - handle token refresh\n    apiClient.interceptors.response.use(\n      (response) => response,\n      async (error) => {\n        const originalRequest = error.config;\n\n        if (\n          error.response?.status === 401 &&\n          error.response?.data?.code === 'TOKEN_EXPIRED' &&\n          !originalRequest._retry\n        ) {\n          originalRequest._retry = true;\n\n          try {\n            await this.refreshToken();\n            // Retry original request with new token\n            const token = this.getToken();\n            if (token) {\n              originalRequest.headers.Authorization = `Bearer ${token}`;\n            }\n            return apiClient(originalRequest);\n          } catch (refreshError) {\n            // Refresh failed, redirect to login\n            this.logout();\n            window.location.href = '/login';\n            return Promise.reject(refreshError);\n          }\n        }\n\n        return Promise.reject(error);\n      }\n    );\n  }\n\n  /**\n   * Store access token\n   */\n  setToken(token) {\n    if (token) {\n      localStorage.setItem(TOKEN_KEY, token);\n    } else {\n      localStorage.removeItem(TOKEN_KEY);\n    }\n  }\n\n  /**\n   * Get stored access token\n   */\n  getToken() {\n    return localStorage.getItem(TOKEN_KEY);\n  }\n\n  /**\n   * Check if user is authenticated\n   */\n  isAuthenticated() {\n    const token = this.getToken();\n    if (!token) return false;\n\n    try {\n      // Basic JWT structure check\n      const payload = JSON.parse(atob(token.split('.')[1]));\n      const now = Date.now() / 1000;\n      return payload.exp > now;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Get current user info from token\n   */\n  getCurrentUser() {\n    const token = this.getToken();\n    if (!token) return null;\n\n    try {\n      const payload = JSON.parse(atob(token.split('.')[1]));\n      return {\n        id: payload.userId,\n        email: payload.email,\n        plan: payload.plan,\n        status: payload.status\n      };\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Register new user\n   */\n  async register(userData) {\n    try {\n      const response = await apiClient.post('/auth/register', userData);\n      \n      if (response.data.accessToken) {\n        this.setToken(response.data.accessToken);\n      }\n      \n      return response.data;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Login user\n   */\n  async login(credentials) {\n    try {\n      const response = await apiClient.post('/auth/login', credentials);\n      \n      if (response.data.accessToken) {\n        this.setToken(response.data.accessToken);\n      }\n      \n      return response.data;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Refresh access token\n   */\n  async refreshToken() {\n    try {\n      const response = await apiClient.post('/auth/refresh');\n      \n      if (response.data.accessToken) {\n        this.setToken(response.data.accessToken);\n      }\n      \n      return response.data;\n    } catch (error) {\n      this.setToken(null); // Clear invalid token\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Logout user\n   */\n  async logout() {\n    try {\n      await apiClient.post('/auth/logout');\n    } catch (error) {\n      // Continue with logout even if API call fails\n      console.error('Logout API call failed:', error);\n    } finally {\n      this.setToken(null);\n    }\n  }\n\n  /**\n   * Logout from all devices\n   */\n  async logoutAll() {\n    try {\n      await apiClient.post('/auth/logout-all');\n    } catch (error) {\n      console.error('Logout all API call failed:', error);\n    } finally {\n      this.setToken(null);\n    }\n  }\n\n  /**\n   * Get user profile\n   */\n  async getProfile() {\n    try {\n      const response = await apiClient.get('/auth/profile');\n      return response.data;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Update user profile\n   */\n  async updateProfile(profileData) {\n    try {\n      const response = await apiClient.put('/auth/profile', profileData);\n      return response.data;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Change password\n   */\n  async changePassword(passwordData) {\n    try {\n      const response = await apiClient.put('/auth/change-password', passwordData);\n      return response.data;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Handle API errors consistently\n   */\n  handleError(error) {\n    if (error.response) {\n      // Server responded with error status\n      const { data, status } = error.response;\n      return {\n        message: data.message || 'An error occurred',\n        details: data.details || [],\n        code: data.code,\n        status\n      };\n    } else if (error.request) {\n      // Request made but no response\n      return {\n        message: 'Network error - please check your connection',\n        code: 'NETWORK_ERROR'\n      };\n    } else {\n      // Something else happened\n      return {\n        message: error.message || 'An unexpected error occurred',\n        code: 'UNKNOWN_ERROR'\n      };\n    }\n  }\n}\n\n// Create and export singleton instance\nconst authService = new AuthService();\nexport default authService;\n\n// Also export the configured axios instance for other services\nexport { apiClient };