# StockSpot Cluster Configuration
# 
# This file configures the distributed cluster layer for StockSpot.
# It supports Redis Streams for distributed queuing with SQLite fallback,
# worker autoscaling, rate limiting, and leader election.

# =============================================================================
# REDIS CONFIGURATION
# =============================================================================
redis:
  host: "localhost"
  port: 6379
  db: 0
  password: null  # Set via REDIS_PASSWORD environment variable
  socket_timeout: 5.0
  socket_connect_timeout: 5.0
  health_check_interval: 30.0
  max_connections: 50
  
  # Connection pool settings
  connection_pool:
    max_connections: 20
    retry_on_timeout: true
    
  # Sentinel configuration (for high availability)
  sentinel:
    enabled: false
    hosts: []
    master_name: "mymaster"
    
  # Cluster configuration (for Redis Cluster)
  cluster:
    enabled: false
    startup_nodes: []

# =============================================================================
# QUEUE SYSTEM CONFIGURATION  
# =============================================================================
queue:
  # Stream names for different task types
  stream_names:
    - "posting_tasks"
    - "scraping_tasks" 
    - "enrichment_tasks"
    - "analytics_tasks"
  
  # Consumer group settings
  consumer_group: "stockspot_workers"
  consumer_prefix: "worker"
  
  # Message processing settings
  max_len: 10000  # Maximum messages per stream
  block_time: 1000  # Block time in milliseconds
  count: 10  # Number of messages to read at once
  
  # Retry and cleanup settings
  max_retries: 3
  retry_delay: 300  # 5 minutes
  stale_timeout: 1800  # 30 minutes
  cleanup_interval: 600  # 10 minutes
  
  # SQLite fallback settings
  sqlite:
    db_path: "./logs/queue.db"
    batch_size: 100
    vacuum_interval: 86400  # 24 hours

# =============================================================================
# WORKER CONFIGURATION
# =============================================================================
worker:
  # Worker scaling settings
  min_workers: 1
  max_workers: 8
  initial_workers: 2
  
  # Autoscaling configuration
  auto_scaling_enabled: true
  scale_up_threshold: 20    # Scale up when queue depth > 20
  scale_down_threshold: 5   # Scale down when queue depth < 5
  
  # Management settings
  management_interval: 30.0  # Seconds between management checks
  leader_only_management: true  # Only leader performs scaling decisions
  
  # Worker lifecycle
  startup_timeout: 60.0     # Max time to wait for worker startup
  shutdown_timeout: 30.0    # Max time to wait for graceful shutdown
  heartbeat_interval: 30.0  # Worker heartbeat frequency
  health_check_interval: 60.0  # Health check frequency

# =============================================================================
# LEADER ELECTION CONFIGURATION
# =============================================================================
leader:
  # Redis-based leader election
  election_key: "stockspot:leader"
  ttl_seconds: 30
  renewal_interval: 10.0
  
  # File-based fallback
  fallback_lock_file: "./logs/leader.lock"

# =============================================================================
# DISTRIBUTED LOCKS CONFIGURATION
# =============================================================================
distributed_locks:
  # Redis settings
  redis_key_prefix: "stockspot:lock"
  default_timeout: 300  # 5 minutes
  retry_interval: 0.1   # 100ms between retries
  
  # Auto-renewal settings
  auto_renewal: true
  renewal_interval: 60.0  # 1 minute
  
  # SQLite fallback
  sqlite_db_path: "./logs/locks.db"

# =============================================================================
# RATE LIMITING CONFIGURATION
# =============================================================================
rate_limiting:
  # Redis settings
  redis_key_prefix: "stockspot:ratelimit"
  
  # SQLite fallback
  sqlite_db_path: "./logs/ratelimits.db"
  
  # Default limits (applied if not specified)
  default_limits:
    requests_per_minute: 60
    requests_per_hour: 1000
    requests_per_day: 10000
  
  # Platform-specific limits
  platform_limits:
    twitter:
      requests_per_hour: 300
      requests_per_day: 1000
    reddit:
      requests_per_hour: 600  
      requests_per_day: 3000
    shopify:
      requests_per_hour: 200
      requests_per_day: 2000
    rss:
      requests_per_hour: 120
      requests_per_day: 1000

# =============================================================================
# HEALTH MONITORING CONFIGURATION
# =============================================================================
health:
  # Check intervals
  check_interval: 60.0     # Seconds between health checks
  component_timeout: 10.0  # Timeout for individual component checks
  
  # Thresholds for warnings/alerts
  thresholds:
    cpu_warning: 70.0      # CPU usage % warning threshold
    cpu_critical: 90.0     # CPU usage % critical threshold
    memory_warning: 80.0   # Memory usage % warning threshold  
    memory_critical: 90.0  # Memory usage % critical threshold
    disk_warning: 85.0     # Disk usage % warning threshold
    disk_critical: 95.0    # Disk usage % critical threshold
    
  # Health check components
  components:
    - "redis"
    - "sqlite" 
    - "queue_system"
    - "system_resources"
    - "disk_space"
    - "process"

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  
  # File logging
  file:
    enabled: true
    path: "./logs/cluster.log"
    max_bytes: 10485760  # 10MB
    backup_count: 5
    
  # Console logging  
  console:
    enabled: true
    level: "INFO"
    
  # Specific logger levels
  loggers:
    "app.cluster": "DEBUG"
    "redis": "WARNING" 
    "sqlite3": "WARNING"

# =============================================================================
# DEVELOPMENT/TESTING CONFIGURATION
# =============================================================================
development:
  # Force SQLite mode (disable Redis)
  force_sqlite: false
  
  # Debug settings
  debug_mode: false
  verbose_logging: false
  
  # Testing overrides
  test_mode: false
  mock_external_services: false