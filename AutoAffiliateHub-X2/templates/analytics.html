{% extends "layout.html" %}

{% block title %}Revenue Analytics - StockSpot{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .metric-card {
        @apply bg-white rounded-lg shadow-md p-6 border border-gray-200 hover:shadow-lg transition-shadow;
    }
    
    .metric-value {
        @apply text-3xl font-bold text-gray-900;
    }
    
    .metric-label {
        @apply text-sm text-gray-600 uppercase tracking-wide;
    }
    
    .performance-badge {
        @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
    }
    
    .badge-excellent {
        @apply bg-green-100 text-green-800;
    }
    
    .badge-good {
        @apply bg-blue-100 text-blue-800;
    }
    
    .badge-average {
        @apply bg-yellow-100 text-yellow-800;
    }
    
    .badge-poor {
        @apply bg-red-100 text-red-800;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Revenue Analytics & Performance Intelligence</h1>
                    <p class="mt-2 text-gray-600">AI-powered insights into your affiliate marketing performance</p>
                </div>
                <div class="space-x-3">
                    <button onclick="refreshMetrics()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ðŸ”„ Refresh Metrics
                    </button>
                    <button onclick="exportData()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ðŸ“Š Export Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="metric-card">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ðŸ’°</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="metric-label">Total Revenue</dt>
                            <dd class="metric-value text-green-600">${{ summary_stats.total_revenue }}</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ðŸ‘†</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="metric-label">Total Clicks</dt>
                            <dd class="metric-value text-blue-600">{{ summary_stats.total_clicks }}</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ðŸŽ¯</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="metric-label">Conversion Rate</dt>
                            <dd class="metric-value text-purple-600">{{ "%.2f"|format(summary_stats.avg_conversion_rate) }}%</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-lg">ðŸ“ˆ</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="metric-label">Avg EPC</dt>
                            <dd class="metric-value text-orange-600">${{ "%.2f"|format(summary_stats.avg_epc) }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Platform Revenue Chart -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Revenue by Platform</h2>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        {% if summary_stats.has_ml_support %}
                            ðŸ¤– ML-Enhanced Analytics
                        {% else %}
                            ðŸ“Š Rule-Based Analytics
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="relative h-64">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Top Performing Deals Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">Top 10 Performing Deals</h2>
                <p class="mt-1 text-sm text-gray-600">Ranked by AI performance score</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deal Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CTR</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EPC</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conversions</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI Score</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for deal in top_performers %}
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    {% if loop.index <= 3 %}
                                        <span class="text-lg">
                                            {% if loop.index == 1 %}ðŸ¥‡
                                            {% elif loop.index == 2 %}ðŸ¥ˆ
                                            {% else %}ðŸ¥‰
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                    <span class="ml-2 text-sm font-medium text-gray-900">#{{ loop.index }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900 max-w-xs truncate" title="{{ deal.deal_title }}">
                                    {{ deal.deal_title }}
                                </div>
                                <div class="text-sm text-gray-500">ID: {{ deal.post_id }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if deal.platform == 'Amazon' %}bg-orange-100 text-orange-800
                                    {% elif deal.platform == 'Walmart' %}bg-blue-100 text-blue-800
                                    {% elif deal.platform == 'Target' %}bg-red-100 text-red-800
                                    {% elif deal.platform == 'Bestbuy' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800
                                    {% endif %}">
                                    {{ deal.platform }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ "%.2f"|format(deal.ctr) }}%
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${{ "%.2f"|format(deal.epc) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ deal.total_conversions }}
                                <span class="text-gray-500">({{ "%.1f"|format(deal.conversion_rate) }}%)</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                                ${{ "%.2f"|format(deal.total_revenue) }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <span class="text-sm font-medium text-gray-900">{{ "%.1f"|format(deal.performance_score) }}</span>
                                    <div class="ml-2">
                                        {% if deal.performance_score >= 80 %}
                                            <span class="performance-badge badge-excellent">Excellent</span>
                                        {% elif deal.performance_score >= 60 %}
                                            <span class="performance-badge badge-good">Good</span>
                                        {% elif deal.performance_score >= 40 %}
                                            <span class="performance-badge badge-average">Average</span>
                                        {% else %}
                                            <span class="performance-badge badge-poor">Poor</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Platform Breakdown -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Platform Performance Cards -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Platform Performance Breakdown</h3>
                <div class="space-y-4">
                    {% for platform, data in platform_analytics.items() %}
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-3
                                {% if platform == 'Amazon' %}bg-orange-500
                                {% elif platform == 'Walmart' %}bg-blue-500
                                {% elif platform == 'Target' %}bg-red-500
                                {% elif platform == 'Bestbuy' %}bg-yellow-500
                                {% else %}bg-gray-500
                                {% endif %}">
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">{{ platform }}</div>
                                <div class="text-sm text-gray-500">{{ data.post_count }} posts</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium text-gray-900">${{ data.total_revenue }}</div>
                            <div class="text-sm text-gray-500">EPC: ${{ "%.2f"|format(data.avg_epc) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- AI Insights Panel -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ðŸ¤– AI Performance Insights</h3>
                <div class="space-y-4">
                    
                    <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                        <div class="flex">
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    <strong>Best Performing Platform:</strong> 
                                    {% set best_platform = platform_analytics|dictsort(attribute='1.total_revenue')|reverse|first %}
                                    {{ best_platform[0] }} with ${{ best_platform[1].total_revenue }} revenue
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                        <div class="flex">
                            <div class="ml-3">
                                <p class="text-sm text-green-700">
                                    <strong>Optimization Tip:</strong> 
                                    {% if summary_stats.avg_conversion_rate < 2 %}
                                        Focus on improving deal quality and targeting to boost conversion rates.
                                    {% elif summary_stats.avg_epc < 1 %}
                                        Consider promoting higher-value products to increase earnings per click.
                                    {% else %}
                                        Great performance! Continue monitoring top-performing deal patterns.
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                        <div class="flex">
                            <div class="ml-3">
                                <p class="text-sm text-purple-700">
                                    <strong>ML Status:</strong> 
                                    {% if summary_stats.has_ml_support %}
                                        âœ… Advanced ML models active for predictive analytics
                                    {% else %}
                                        ðŸ“Š Using rule-based analytics (install scikit-learn for ML features)
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                        <div class="flex">
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    <strong>Data Quality:</strong> 
                                    {{ summary_stats.total_posts }} posts tracked with 
                                    {{ summary_stats.total_clicks }} total interactions
                                </p>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>Analytics powered by StockSpot Monetization Engine</p>
            <p class="mt-1">Last updated: <span id="lastUpdated">{{ moment().format('YYYY-MM-DD HH:mm:ss') }}</span></p>
        </div>

    </div>
</div>

<script>
// Chart.js Revenue by Platform Chart
const ctx = document.getElementById('revenueChart').getContext('2d');
const platformData = {{ platform_analytics|tojson }};

const labels = Object.keys(platformData);
const revenues = Object.values(platformData).map(p => p.total_revenue);
const colors = {
    'Amazon': '#FF9500',
    'Walmart': '#004C91', 
    'Target': '#CC0000',
    'Bestbuy': '#FFE135',
    'Unknown': '#6B7280'
};

const backgroundColors = labels.map(label => colors[label] || colors['Unknown']);

const revenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Revenue ($)',
            data: revenues,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(color => color + '80'),
            borderWidth: 2,
            borderRadius: 6,
            borderSkipped: false,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `Revenue: $${context.parsed.y.toFixed(2)}`;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value;
                    }
                }
            }
        }
    }
});

// Refresh metrics function
async function refreshMetrics() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = 'ðŸ”„ Refreshing...';
    button.disabled = true;
    
    try {
        const response = await fetch('/analytics', {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache'
            }
        });
        
        if (response.ok) {
            // Reload the page to show updated data
            window.location.reload();
        } else {
            alert('Failed to refresh metrics. Please try again.');
        }
    } catch (error) {
        console.error('Error refreshing metrics:', error);
        alert('Error refreshing metrics. Please check your connection.');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Export data function
async function exportData() {
    try {
        const response = await fetch('/analytics/export', {
            method: 'GET'
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `stockspot_analytics_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            alert('Failed to export data. Please try again.');
        }
    } catch (error) {
        console.error('Error exporting data:', error);
        alert('Error exporting data. Please check your connection.');
    }
}

// Update timestamp
document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
</script>

{% endblock %}